<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Galactly — Login</title>

  <!-- Strip index.html from URL -->
  <script>
    (function () {
      if (/\/index\.html$/i.test(location.pathname)) {
        var q = location.search || '', h = location.hash || '';
        var p = location.pathname.replace(/index\.html$/i, '');
        if (!/\/$/.test(p)) p += '/';
        history.replaceState(null, '', p + q + h);
      }
    })();
  </script>

  <link rel="canonical" href="https://galactly.com/auth/login/">

  <!-- Build-time config shims -->
  <script>
    window.__FIREBASE_CONFIG__ = {
      apiKey: "AIzaSyCBf7LHL4PfxD2rH7-HdYSE2dXIGfb3Vz4",
      authDomain: "artemiss-42e40.firebaseapp.com",
      projectId: "artemiss-42e40",
      appId: "1:384891834378:web:53624662894e0650a74ff3"
    };
    window.__SECURITY__ = {
      turnstileSiteKey: "0x4AAAAAACDlednuZg0WgvLG",
      // hcaptchaSiteKey: "…", // optional
      humanVerifyEndpoint: "/api/verify-human"
    };
  </script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@600;700;800&display=swap" rel="stylesheet"/>

  <!-- Favicons -->
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png?v=3">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png?v=3">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png?v=3">
  <link rel="manifest" href="/site.webmanifest?v=3">
  <link rel="shortcut icon" href="/favicon.ico">

  <style>
    :root{
      --content-w: min(960px, 92vw);
      --title-fs: clamp(28px, 5.6vw, 58px);
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
      --ctl-h: 46px; --ctl-r: 16px;
      --bevel-light: rgba(255,255,255,.35);
      --bevel-dark: rgba(0,0,0,.55);
      --pane-bg-2: rgba(0,0,0,.16);
      --fg: #e9ecf3; --muted: #a9b2c2;
      --gap-title-subtitle: 10px; --gap-subtitle-chips: 14px; --gap-chips-hr: 18px;
      --gap-hr-error: 12px; --gap-error-or: 16px; --gap-or-field: 18px; --gap-bottom-edge: 64px;
      --topbar-pad-x: 20px; --topbar-pad-y: 10px;
      --cta-d: 36px; --stage-lift-m: 0px; --stage-lift-d: 0px;
    }
    @media (min-width:768px){
      :root{
        --gap-title-subtitle: 12px; --gap-subtitle-chips: 16px; --gap-chips-hr: 22px;
        --gap-hr-error: 14px; --gap-error-or: 18px; --gap-or-field: 22px; --gap-bottom-edge: 88px;
        --cta-d: 40px;
      }
    }
    html,body{height:100%;margin:0;background-color:#0c1020;}
    body{
      color:var(--fg);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 800px at 76% 26%, rgba(240,196,90,.28) 0%, transparent 58%),
        radial-gradient(1200px 800px at 24% 78%, rgba(64,186,255,.24) 0%, transparent 60%),
        radial-gradient(700px 500px at 50% -8%, rgba(255,255,255,.08) 0%, transparent 70%),
        linear-gradient(180deg, #171a17, #0f1210);
      background-blend-mode: screen, screen, normal, normal;
      overflow-y:auto; -webkit-overflow-scrolling:touch;
    }
    .wrap{ min-height:100dvh; display:grid; place-items:center; padding: calc(0px + var(--safe-top)) 16px calc(0px + var(--safe-bottom)); }
    .stage{ width:var(--content-w); transform: translateY(var(--stage-lift-m)); transition: transform .2s ease; }
    @media (min-width:768px){ .stage{ transform: translateY(var(--stage-lift-d)); } }

    .topbar{ position:fixed; top: calc(var(--safe-top) + var(--topbar-pad-y)); left:0; right:0; z-index:10; display:flex; align-items:center; justify-content:space-between; padding:0 var(--topbar-pad-x); }
    .brand{ display:flex; align-items:center; gap:10px; color:var(--fg); text-decoration:none; padding:6px 8px; border-radius:12px; }
    .brand img{height:22px; width:auto}
    .brand span{ font:800 14px/1 "Plus Jakarta Sans"; letter-spacing:.2px; }
    .home-link{ display:inline-flex; align-items:center; justify-content:center; padding:6px 8px; background:none; border:0; line-height:0; color: var(--fg); }
    .home-link svg{ width:22px; height:22px; display:block; }
    @media (min-width:1024px){ .home-link svg{ width:28px; height:28px; } }

    h1{ font:800 var(--title-fs)/1.05 "Plus Jakarta Sans"; margin:0 0 18px 0; text-shadow:0 1px 0 rgba(0,0,0,.35); text-align:center; }
    .subtitle{ color:var(--muted); margin:0 0 22px 0; text-align:center }
    .center { display:grid; gap:16px; place-items:center; }

    .cardless{ max-width:860px; margin-inline:auto; }
    .title-row{ text-align:center; margin:0 0 8px 0; }
    .hr{ width:min(560px, 86vw); height:1px; margin:14px auto var(--gap-hr-error); background:linear-gradient(90deg, transparent, rgba(255,255,255,.14), transparent) }
    .muted{ color:var(--muted); font-size:14px; text-align:center }

    .chip-row{ display:flex; gap:18px; flex-wrap:wrap; justify-content:center }
    .chip{
      --local-h: var(--ctl-h);
      position:relative; display:inline-grid; grid-auto-flow:column; align-items:center; gap:10px;
      height:var(--local-h); padding:0 18px; border-radius:calc(var(--ctl-r) + 4px);
      color:var(--fg); text-decoration:none; font-weight:600;
      background:
        linear-gradient(-70deg, transparent 44%, rgba(255,255,255,.22) 51%, transparent 58%),
        linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.015)),
        radial-gradient(120% 120% at 50% 45%, rgba(255,255,255,.04), rgba(0,0,0,.22));
      background-clip: padding-box;
      border:1px solid rgba(255,255,255,.16);
      box-shadow: inset 0 1px 0 var(--bevel-light), inset 0 -2px 5px var(--bevel-dark), inset 0 10px 22px var(--pane-bg-2), 0 2px 8px rgba(0,0,0,.25);
      backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
      transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease;
    }
    .chip:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.22); box-shadow: inset 0 1px 0 var(--bevel-light), inset 0 -2px 5px var(--bevel-dark), inset 0 12px 24px var(--pane-bg-2), 0 6px 18px rgba(0,0,0,.32); }

    .inline-error{
      width:min(560px, 86vw); margin:0 auto; margin-bottom: var(--gap-error-or);
      font-size: 13px; line-height: 1.35; padding: 10px 12px; border-radius: 10px;
      border:1px solid rgba(255,107,107,.35); background: rgba(255,107,107,.12); color: #ffd7d7;
    }
    .inline-error a{ color: currentColor; text-decoration: underline; text-underline-offset: 2px; font-weight: 600; }
    .inline-error a:hover, .inline-error a:focus-visible { text-decoration-thickness: 2px; outline: none; }

    .inline-success{
      width:min(560px, 86vw); margin:0 auto; margin-bottom: var(--gap-error-or);
      font-size: 13px; line-height: 1.35; padding: 10px 12px; border-radius: 10px;
      border:1px solid rgba(255,255,255,.85); background: rgba(255,255,255,.94); color:#0e1420;
      box-shadow: 0 2px 14px rgba(0,0,0,.22), inset 0 1px 0 rgba(255,255,255,.6);
    }
    .inline-note{
      width:min(560px, 86vw); margin: 8px auto 0; font-size: 13px; line-height: 1.35; padding: 10px 12px; border-radius: 10px;
      border:1px solid rgba(255,255,255,.18); background: rgba(255,255,255,.08); color: var(--fg);
    }

    .small-row{ display:flex; gap:10px; justify-content:center; margin-top:8px; font-size:12px; color:var(--muted); }
    .small-row a{ color:var(--fg); text-decoration:underline; cursor:pointer }

    .field-wrap{ width:min(320px, 86vw); margin: 24px auto 0 auto; position:relative; }
    .pressed{
      position:relative; display:grid; grid-template-columns: 26px 1fr; align-items:center;
      height:var(--ctl-h); border-radius:var(--ctl-r); padding:0 14px; background: transparent;
      border:1px solid rgba(255,255,255,.16);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.02), inset 0 -3px 6px rgba(0,0,0,.58), inset 0 12px 26px rgba(0,0,0,.22);
      backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
      transition: box-shadow .15s ease, border-color .15s ease;
    }
    .pressed::before{ content:""; position:absolute; inset:0; border-radius:inherit; padding:0.1px;
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0); -webkit-mask-composite: xor; mask-composite: exclude;
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.10));
      pointer-events:none;
    }
    .pressed:has(input:focus){ border-color: rgba(255,255,255,.24); box-shadow:
      inset 0 1px 0 rgba(255,255,255,.25), inset 0 -3px 6px rgba(0,0,0,.6), inset 0 12px 26px rgba(0,0,0,.22), 0 8px 22px rgba(0,0,0,.30); }

    .left-icon{display:inline-grid; place-items:center; width:24px; color:#e7e7e7; opacity:.9}
    input{ min-width:0; background:transparent; border:0; outline:0; color:var(--fg); font-size:14px; padding:0 8px; height:calc(var(--ctl-h) - 2px); padding-right: calc(var(--cta-d) + 14px); }
    input::placeholder{ color:rgba(233,236,243,.62); }

    .field-cta{
      position:absolute; right:6px; top:50%; width:var(--cta-d); height:var(--cta-d);
      transform: translate(10px,-50%) scale(.9); opacity:0; pointer-events:none;
      border-radius:999px; border:1px solid rgba(255,255,255,.16);
      background:
        radial-gradient(140% 90% at 50% -20%, rgba(255,255,255,.22) 0%, rgba(255,255,255,.06) 28%, rgba(255,255,255,0) 60%),
        radial-gradient(120% 120% at 50% 40%, rgba(255,255,255,.05), rgba(0,0,0,.45));
      box-shadow: inset 0 1px 0 rgba(255,255,255,.25), inset 0 -3px 6px rgba(0,0,0,.6), inset 0 14px 28px rgba(0,0,0,.28), 0 4px 14px rgba(0,0,0,.28);
      backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
      color:var(--fg); display:grid; place-items:center; cursor:pointer;
      transition: transform .18s cubic-bezier(.25,1,.5,1), opacity .18s ease, box-shadow .2s ease, border-color .2s ease;
    }
    .pressed.show-cta .field-cta{ opacity:1; pointer-events:auto; transform: translate(0,-50%) scale(1); }

    :root{ --leave-ms: 1200ms; }
    body.leaving .stage{
      opacity: 0; transform: translateY(12px) scale(.985); filter: blur(2px);
      transition: transform var(--leave-ms) cubic-bezier(.22,1,.36,1), opacity var(--leave-ms) ease, filter var(--leave-ms) ease;
    }
    body.leaving::after{
      content:""; position:fixed; inset:0;
      background: radial-gradient(1200px 800px at 50% 40%, rgba(0,0,0,.5), rgba(0,0,0,.86));
      pointer-events:none; opacity:0; transition: opacity var(--leave-ms) ease;
    }
    body.leaving::after{ opacity:1; }

    .btn-icon{
      display:inline-flex; align-items:center; justify-content:center;
      width:44px; height:44px; border-radius:999px; color:var(--fg);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.18);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.1), 0 10px 26px rgba(0,0,0,.24);
      backdrop-filter: blur(6px);
      cursor:pointer;
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease, opacity .18s ease;
    }
    .btn-icon[disabled]{ opacity:.4; pointer-events:none; }
    .btn-icon:hover{ transform: translateY(-1px); border-color:rgba(255,255,255,.26); box-shadow: inset 0 1px 0 rgba(255,255,255,.14), 0 16px 38px rgba(0,0,0,.28); }
    .btn-icon svg{ width:20px; height:20px; }

    .visually-hidden{ position:absolute !important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }

    .single-action{ display:grid; place-items:center; margin-top:14px; }
    .error{ display:none !important; }
    [hidden]{ display:none !important; }
  </style>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <!-- Human verification (invisible) -->
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
  <script src="https://js.hcaptcha.com/1/api.js" async defer></script>
</head>
<body>

  <!-- top chrome -->
  <div class="topbar">
    <a class="brand" href="/" aria-label="Galactly">
      <img alt="Galactly" src="" id="brandLogo"/>
      <span class="brand-word">Galactly</span>
    </a>
    <a class="home-link" href="/" aria-label="Home">
      <svg viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 10.5L12 3l9 7.5"/>
        <path d="M5 10v9a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-9"/>
        <path d="M9 21v-6a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v6"/>
      </svg>
    </a>
  </div>

  <main class="wrap">
    <div class="stage cardless" aria-live="polite">

      <div class="title-row">
        <h1 class="anim-title">Login</h1>
        <p class="subtitle anim-sub">Sign in with</p>
      </div>

      <div class="center">
        <div class="chip-row">
          <a class="chip" id="googleBtn" href="#" aria-label="Sign in with Google (work)">
            <span class="glare" aria-hidden="true"></span>
            <svg width="20" height="20" viewBox="0 0 533.5 544.3" role="img" aria-hidden="true" focusable="false">
              <path fill="#4285F4" d="M533.5 278.4c0-18.4-1.7-36-4.9-53.1H272v100.5h146.9c-6.3 34-25 62.8-53.1 82v68h85.7c50.1-46.2 81.9-114.1 81.9-197.4z"/>
              <path fill="#34A853" d="M272 544.3c72.2 0 132.8-23.9 177.1-64.9l-85.7-68c-23.8 16-54.2 25.5-91.4 25.5-70 0-129.4-47.2-150.6-110.8H33.1v69.6c44.2 87.8 135.2 148.6 238.9 148.6z"/>
              <path fill="#FBBC04" d="M121.4 326.1c-11.2-33.5-11.2-69.6 0-103.1V153.4H33.1c-40.1 79.9-40.1 175.2 0 255.1l88.3-69.6z"/>
              <path fill="#EA4335" d="M272 107.7c39.2-.6 76.7 14 104.8 41.2l78.3-78.3C411.7 18.1 344.2-5.3 272 0 168.3 0 77.3 60.8 33.1 148.6l88.3 69.6C142.7 154.6 202 107.7 272 107.7z"/>
            </svg>
            <span>Google</span>
          </a>
        </div>
      </div>

      <div class="hr anim-divider" aria-hidden="true"></div>

      <!-- Status/error area -->
      <div id="inlineStatus" class="inline-error" role="alert" hidden></div>

      <!-- Invite banner -->
      <div id="inviteBanner" class="inline-note" hidden>
        <span id="inviteText">You've been invited. Use your work email to join your company workspace.</span>
      </div>

      <!-- Verification panel (shown when user exists but email not verified) -->
      <div id="verifyPanel" class="inline-note" hidden>
        <div id="verifyMsg">
          We sent a verification link to <strong id="vEmail">—</strong>. Open it on this device to continue.
        </div>
        <div class="small-row">
          <a id="resendLink">Resend</a><span>·</span><a id="changeEmail">Use a different email</a>
        </div>
      </div>

      <!-- Below-line group -->
      <section id="auth-section" aria-labelledby="emailLabel">
        <div id="s2-or" class="muted anim-or">OR</div>

        <!-- email -->
        <div class="field-wrap anim-field">
          <label id="emailLabel" class="visually-hidden" for="email" aria-hidden="true" hidden>Email</label>
          <div class="pressed" id="emailBox">
            <span class="left-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="5" width="18" height="14" rx="3"/><path d="M3 7l9 6 9-6"/>
              </svg>
            </span>
            <input id="email" type="email" inputmode="email" autocomplete="email" placeholder="Work email"/>
            <button id="emailNext" class="field-cta" type="button" aria-label="Continue">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 18l6-6-6-6"></path>
              </svg>
            </button>
          </div>
        </div>

        <!-- password -->
        <div class="field-wrap" id="pwdWrap" hidden>
          <div class="pressed" id="pwdBox">
            <span class="left-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="11" width="18" height="10" rx="3"/><path d="M7 11V8a5 5 0 0 1 10 0v3"/>
              </svg>
            </span>
            <input id="password" type="password" autocomplete="current-password" placeholder="Password"/>
            <button id="pwdNext" class="field-cta" type="button" aria-label="Sign in">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 18l6-6-6-6"></path>
              </svg>
            </button>
          </div>
          <div class="small-row">
            <a id="forgotLink" href="#" role="button">Forgot password?</a>
          </div>
        </div>

        <div class="single-action">
          <button type="button" id="backBtn" class="btn-icon" aria-label="Back" hidden>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M15 18l-6-6 6-6"></path>
            </svg>
          </button>
        </div>

        <!-- Static row (signup only) -->
        <div class="small-row" id="signupRow">
          <span>Don't have an account?</span>
          <a id="goSignup" href="/auth/signup/">Create one</a>
        </div>
      </section>
    </div>
  </main>

  <!-- Invisible captcha targets -->
  <div id="human-zone" style="position:fixed;left:-9999px;top:0;width:1px;height:1px;overflow:hidden;">
    <div id="cf-turnstile"></div>
    <div id="hcaptcha"></div>
  </div>

  <!-- Brand icon render -->
  <style>
    .site-header .brand, .topbar .brand{ display:flex; align-items:center; --icon-w:36px; --brand-gap:4px; gap:var(--brand-gap);}
    .brand-icon{ --gg-gap-x:10px; --left-dim:.65; --stroke-w:3; }
    .brand-icon svg{ width:var(--icon-w); height:var(--icon-w); display:block; }
    .brand-word{ font:800 22px/1 "Plus Jakarta Sans"; background:linear-gradient(180deg,#FFF,#E6EEF7); -webkit-background-clip:text; background-clip:text; color:transparent; letter-spacing:.2px; white-space:nowrap; }
    .brand-icon .stroke{ vector-effect: non-scaling-stroke; stroke-linecap: round; stroke-linejoin: round; }
    .brand-icon .piece{ transform-box: view-box; transform-origin: 50% 50%; }
  </style>
  <script>
    (function tryLogo(){
      const candidates = [
        "/assets/logo/galactly-logo.svg","/assets/logo/logo.svg","/assets/brand/galactly-logo.svg","/assets/branding/galactly-logo.svg",
        "/img/galactly-logo.svg","/images/logo.svg","/logo.svg","/assets/logo.png","/images/logo.png"
      ];
      const el = document.getElementById("brandLogo");
      let i = 0;
      (function next(){
        if(i>=candidates.length){ try{ el.remove(); }catch{} return; }
        const src = candidates[i++], img = new Image();
        img.onload = () => el.src = src;
        img.onerror = next;
        img.src = src;
      })();
    })();
    (function(){
      const brand = document.querySelector('.topbar .brand') || document.querySelector('.site-header .brand');
      if(!brand) return;
      const icon = `
<svg viewBox="0 0 64 64" aria-label="Galactly double G" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <symbol id="gSym" viewBox="0 0 320 860" overflow="visible">
      <path id="gPath" d="M 209.5 474.25 H 261.5 C 261.667 524.583 262 630.45 262 651.25 C 262 677.25 242.5 718.75 235.5 730.25 C 228.5 741.75 208.5 760.25 193 770.25 C 177.5 780.25 161 786.25 149.5 786.25 C 140.3 786.25 131.667 779.916 128.5 776.75 C 122.5 771.916 105.6 755.85 86.0003 730.25 C 66.4003 704.65 60.5003 662.583 60.0003 644.75 V 221.25 C 59.667 209.583 61.7003 177.25 72.5003 141.25 C 81.5253 111.166 104.214 87.8332 119.5 75.9188 C 131.5 65.7496 150.57 68.3373 156.5 69.2496 C 163 70.2496 173.834 73.2496 178 74.7496 C 184.834 77.083 195.3 82.5496 206.5 91.7496 C 220.5 103.25 227 113.75 230 119.75 C 236 124.15 248.5 161.25 254 179.25 L 264 247.25 L 269.5 259.25 C 273.834 263.75 285 272.45 295 271.25 C 307.5 269.75 310.5 258.25 314 251.25 C 312 159.25 295 102.75 253.5 51.2496 C 220.3 10.0496 176.667 2.08297 159 3.24964 C 143.5 1.4163 101.8 8.84964 59.0003 53.2496 C 16.2003 97.6496 3.83366 179.416 3.00033 214.75 L 7.00033 649.75 C 7.33366 667.75 12.9003 713.55 32.5003 752.75 C 57.0003 801.75 108.5 847.25 166 847.25 C 211.6 846.45 254.334 803.25 270 781.75 C 292.8 752.55 313.392 681.75 313.5 642.25 C 313.667 581.583 313.9 456.65 313.5 442.25 C 313.1 427.85 304.667 416.916 300.5 413.25 H 204.5 C 198 416.083 185 426.35 185 444.75 C 185 463.15 201.334 472.083 209.5 474.25 Z"/>
    </symbol>
    <linearGradient id="ggFill" x1="0" y1="0" x2="0" y2="1"><stop offset="0" stop-color="#ECF4FF"/><stop offset="0.55" stop-color="#CFE0F3"/><stop offset="1" stop-color="#AEBED2"/></linearGradient>
    <linearGradient id="ggShimmer" x1="0" y1="0" x2="0" y2="1"><stop offset="0" stop-color="#FFFFFF"/><stop offset="1" stop-color="#E9F0F8"/></linearGradient>
    <radialGradient id="ggHalo" cx="50%" cy="45%" r="60%"><stop offset="0" stop-color="#B6E6FF" stop-opacity="0.35"/><stop offset="1" stop-color="#B6E6FF" stop-opacity="0"/></radialGradient>
    <linearGradient id="ggSheen" gradientUnits="userSpaceOnUse" x1="0" y1="0" x2="64" y2="64">
      <stop offset="0" stop-color="#FFFFFF" stop-opacity="0"/><stop offset="0.46" stop-color="#FFFFFF" stop-opacity="0"/><stop offset="0.54" stop-color="#FFFFFF" stop-opacity="0.35"/><stop offset="0.62" stop-color="#FFFFFF" stop-opacity="0"/><stop offset="1" stop-color="#FFFFFF" stop-opacity="0"/>
    </linearGradient>
    <filter id="ggSoftGlow" x="-30%" y="-30%" width="160%" height="160%">
      <feDropShadow dx="0" dy="1" stdDeviation="1.1" flood-color="#000" flood-opacity="0.22"/>
      <feDropShadow dx="0" dy="0" stdDeviation="2.2" flood-color="#9ED8FF" flood-opacity="0.15"/>
    </filter>
  </defs>
  <g pointer-events="none"><circle cx="32" cy="33" r="21" fill="url(#ggHalo)"/></g>
  <g class="piece" style="transform: translateX(calc(var(--gg-gap-x)/2)); filter:url(#ggSoftGlow);">
    <use href="#gSym" width="64" height="64" fill="url(#ggFill)"/>
    <use href="#gSym" width="64" height="64" class="stroke" stroke="url(#ggShimmer)" stroke-width="var(--stroke-w)" fill="none"/>
    <use href="#gSym" width="64" height="64" fill="url(#ggSheen)"/>
  </g>
  <g class="piece" style="transform: translateX(calc(-1 * var(--gg-gap-x)/2)) scaleX(-1); filter:url(#ggSoftGlow); opacity: var(--left-dim);">
    <use href="#gSym" width="64" height="64" fill="url(#ggFill)"/>
    <use href="#gSym" width="64" height="64" class="stroke" stroke="url(#ggShimmer)" stroke-width="var(--stroke-w)" fill="none"/>
    <use href="#gSym" width="64" height="64" fill="url(#ggSheen)"/>
  </g>
</svg>`;
      const word = brand.querySelector('.brand-word')?.outerHTML || '<span class="brand-word">Galactly</span>';
      brand.innerHTML = `<span class="brand-icon" aria-hidden="true">${icon}</span>${word}`;
      brand.setAttribute('aria-label','Galactly');
    })();
  </script>

  <script>
    /* --------------- next= capture & canonicalize legacy links --------------- */
    (function(){
      function captureNext(){
        const p = new URLSearchParams(location.search);
        let next = p.get('next') || sessionStorage.getItem('gg_next') || '';
        if (!next) return '';
        try { next = decodeURIComponent(next); } catch(_){}
        if (/^https?:/i.test(next)) {
          try { const u = new URL(next, location.origin); next = (u.origin === location.origin) ? (u.pathname + u.search + u.hash) : ''; }
          catch(_) { next = ''; }
        }
        if (next && !next.startsWith('/')) next = '';
        if (next) sessionStorage.setItem('gg_next', next);
        return next;
      }
      captureNext();

      (function canonicalize(){
        const map = new Map([
          ['login.html','/auth/login/'],['/login','/auth/login/'],
          ['signup.html','/auth/signup/'],['/signup','/auth/signup/'],
          ['start.html','/auth/signup/'],
          ['bridge.html','/auth/bridge/']
        ]);
        const norm = v => (v||'').replace(/^https?:\/\/[^/]+/i,'').replace(/^\.\//,'');
        const split = v => { const m=String(v||'').match(/^([^?#]*)(.*)$/); return [m?m[1]:'',m?m[2]:'']; };
        document.querySelectorAll('a[href], form[action]').forEach(el=>{
          const attr = el.tagName==='FORM' ? 'action' : 'href';
          const raw  = el.getAttribute(attr); if(!raw) return;
          if (attr==='href' && /^#/.test(raw)) return;
          const [path, rest] = split(norm(raw));
          if (map.has(path)) el.setAttribute(attr, map.get(path) + rest);
        });
      })();
    })();
  </script>

  <script>
    /* ---------------- Page refs ---------------- */
    const byId = (id)=>document.getElementById(id);
    const statusEl   = byId('inlineStatus');
    const emailInput = byId('email');
    const emailNext  = byId('emailNext');
    const emailBox   = byId('emailBox');
    const pwdWrap    = byId('pwdWrap');
    const pwdInput   = byId('password');
    const pwdNext    = byId('pwdNext');
    const backBtn    = byId('backBtn');
    const googleBtn  = byId('googleBtn');
    const inviteBanner = byId('inviteBanner');
    const forgotLink = byId('forgotLink');

    const verifyPanel = byId('verifyPanel');
    const vEmail = byId('vEmail');
    const resendLink = byId('resendLink');
    const changeEmail = byId('changeEmail');

    function qp(name){ return new URLSearchParams(location.search).get(name); }
    function looksValidEmail(v){ return /^[^\s@]+@[^\s@]{2,}\.[^\s@]{2,}$/i.test(String(v||'').trim()); }

    /* Status helpers */
    function setStatusType(type){
      statusEl.classList.remove('inline-error','inline-success','inline-note');
      statusEl.classList.add(type === 'success' ? 'inline-success' : (type === 'note' ? 'inline-note' : 'inline-error'));
    }
    function showStatus(msg, type){ setStatusType(type||'error'); statusEl.textContent = msg || "Something went wrong."; statusEl.hidden = false; }
    function showStatusHTML(html, type){ setStatusType(type||'error'); statusEl.innerHTML = html || "Something went wrong."; statusEl.hidden = false; }
    function hideStatus(){ statusEl.hidden = true; statusEl.textContent = ""; }
    function pulse(el){
      if(!el) return;
      const prev = el.style.boxShadow;
      el.style.transition = 'box-shadow 180ms ease';
      el.style.boxShadow = '0 0 0 2px rgba(255,107,107,.45), inset 0 1px 0 rgba(255,255,255,.12), inset 0 -3px 6px rgba(0,0,0,.6), inset 0 12px 26px rgba(0,0,0,.22)';
      setTimeout(()=>{ el.style.boxShadow = prev; }, 260);
    }

    /* Prefill email + keep ?next in signup link; update when typing */
    (function prefill(){
      const p = new URLSearchParams(location.search);
      const em = p.get('email') || localStorage.getItem('gg_pending_email') || '';
      if(em){ emailInput.value = em; }
      updateEmailCTA();
      function setSignupHref(){
        const link = new URL('/auth/signup/', location.origin);
        const nx = sessionStorage.getItem('gg_next'); if (nx) link.searchParams.set('next', nx);
        const emNow = (emailInput.value||'').trim(); if(emNow) link.searchParams.set('email', emNow);
        byId('goSignup').href = link.pathname + link.search;
      }
      setSignupHref();
      emailInput.addEventListener('input', setSignupHref);
    })();

    const INVITE_CODE = qp('invite');
    if(INVITE_CODE){ inviteBanner.hidden = false; }

    /* Stage toggles */
    function setEmailStage(){
      pwdWrap.hidden = true; backBtn.hidden = true; byId('s2-or').hidden = false;
      verifyPanel.hidden = true; hideStatus(); updateEmailCTA();
    }
    function setPasswordStage(){
      byId('s2-or').hidden = true; pwdWrap.hidden = false; backBtn.hidden = false;
      verifyPanel.hidden = true; hideStatus(); updatePwdCTA(); try{ pwdInput.focus({preventScroll:true}); }catch{}
    }

    function updateEmailCTA(){
      const show = looksValidEmail(emailInput.value);
      emailBox.classList.toggle('show-cta', show);
      emailNext.toggleAttribute('disabled', !show);
    }
    function updatePwdCTA(){
      const show = (pwdInput.value.length >= 6);
      byId('pwdBox').classList.toggle('show-cta', show);
      pwdNext.toggleAttribute('disabled', !show);
    }
    emailInput.addEventListener('input', updateEmailCTA);
    emailInput.addEventListener('blur', updateEmailCTA);
    emailInput.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' && looksValidEmail(emailInput.value)){ e.preventDefault(); emailNext.click(); }
    });
    pwdInput.addEventListener('input', updatePwdCTA);
    pwdInput.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' && pwdInput.value.length >= 6){ e.preventDefault(); pwdNext.click(); }
    });

    /* -------- Firebase init -------- */
    const META_CFG = (()=>{ try{
      const m=document.querySelector('meta[name="firebase-config"]');
      return m && m.content ? JSON.parse(m.content) : null;
    }catch(e){ return null; }})();

    const FIREBASE_CONFIG =
      (window.__FIREBASE_CONFIG__ && typeof window.__FIREBASE_CONFIG__==='object' && window.__FIREBASE_CONFIG__) ||
      (typeof window.firebaseConfig!=='undefined' && window.firebaseConfig) ||
      META_CFG || {
        apiKey: "AIzaSyCBf7LHL4PfxD2rH7-HdYSE2dXIGfb3Vz4",
        authDomain: "artemiss-42e40.firebaseapp.com",
        projectId: "artemiss-42e40",
        appId: "1:384891834378:web:53624662894e0650a74ff3",
      };

    let auth=null, db=null;
    (async function initFirebase(){
      try{
        if(firebase?.apps?.length){
          auth = firebase.auth(); try{ db = firebase.firestore(); }catch(_){}
        }else{
          const looksReal = FIREBASE_CONFIG && Object.values(FIREBASE_CONFIG).every(v => typeof v==='string' && v && !/^YOUR_/i.test(v));
          if(looksReal){
            firebase.initializeApp(FIREBASE_CONFIG);
            auth = firebase.auth(); try{ db = firebase.firestore(); }catch(_){}
          }else{
            const res = await fetch('/__/firebase/init.json', { cache:'no-store' });
            if(res.ok){
              const cfg = await res.json();
              if(cfg && cfg.projectId){
                firebase.initializeApp(cfg);
                auth = firebase.auth(); try{ db = firebase.firestore(); }catch(_){}
              }
            }
          }
        }
        // Explicit LOCAL persistence (free) → same-device auto sign-in
        try{ await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL); }catch(_){}
        hookAuthStateAutoRoute();
      }catch(e){ auth = null; db = null; }
    })();

    /* -------- Human verification (grace window) -------- */
    const SECURITY = (window.__SECURITY__ && typeof window.__SECURITY__==='object' && window.__SECURITY__) || {};
    let humanProvider = null, humanWidgetId = null, humanReady = false;

    function initHuman(){
      const cfKey = SECURITY.turnstileSiteKey && SECURITY.turnstileSiteKey.trim();
      const hcKey = SECURITY.hcaptchaSiteKey && SECURITY.hcaptchaSiteKey.trim();
      if (cfKey && window.turnstile && typeof window.turnstile.render === 'function'){
        try{
          humanWidgetId = window.turnstile.render('#cf-turnstile', {
            sitekey: cfKey, theme: 'dark', size: 'invisible', retry: 'auto',
            'error-callback': ()=>{}, 'timeout-callback': ()=>{}, callback: ()=>{}
          });
          humanProvider = 'turnstile'; humanReady = true; return;
        }catch(_){}
      }
      if (hcKey && window.hcaptcha && typeof window.hcaptcha.render === 'function'){
        try{
          humanWidgetId = window.hcaptcha.render('hcaptcha', { sitekey: hcKey, size: 'invisible', theme: 'dark', callback: ()=>{} });
          humanProvider = 'hcaptcha'; humanReady = true; return;
        }catch(_){}
      }
      humanProvider = null; humanReady = false;
    }
    function resetHuman(){
      try{
        if(humanProvider === 'turnstile' && window.turnstile && humanWidgetId){ window.turnstile.reset(humanWidgetId); }
        if(humanProvider === 'hcaptcha' && window.hcaptcha && humanWidgetId){ window.hcaptcha.reset(humanWidgetId); }
      }catch(_){}
    }
    async function getHumanToken(action){
      if(!humanProvider || !humanReady) return { ok:true, provider:null, token:null, dev:true };
      try{
        if(humanProvider==='turnstile'){
          const token = await window.turnstile.execute(humanWidgetId, { action: action||'login' });
          return { ok: !!token, provider:'turnstile', token };
        }
        if(humanProvider==='hcaptcha'){
          const token = await window.hcaptcha.execute(humanWidgetId, { async: true });
          return { ok: !!token, provider:'hcaptcha', token };
        }
      }catch(_){}
      return { ok:false, provider:humanProvider, token:null };
    }
    async function verifyHumanServerSide(payload){
      const url = SECURITY.humanVerifyEndpoint && SECURITY.humanVerifyEndpoint.trim();
      if(!url) return { ok:true, skipped:true };
      try{
        const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify(payload) });
        if(!res.ok) return { ok:false, status:res.status };
        const data = await res.json().catch(()=>({}));
        return { ok: data?.ok !== false, data };
      }catch(e){ return { ok:false, error:String(e?.message||e||'error') }; }
    }
    window.addEventListener('load', ()=>{ try{ initHuman(); }catch(_){} });

    /* Grace window: require human check only after 3 attempts in this session */
    function getTryCount(){ return parseInt(sessionStorage.getItem('gg_login_tries')||'0',10)||0; }
    function bumpTryCount(){ sessionStorage.setItem('gg_login_tries', String(getTryCount()+1)); }
    function humanNeeded(kind){ return (kind==='invite') ? true : getTryCount() >= 3; }

    /* -------- Helpers -------- */
    const TIMEOUTS = { methods: 3500, sign: 10000, invite: 4000, reset: 6000, create: 12000, sendVerify: 7000 };
    function withTimeout(promise, ms, label){
      let t; const timer = new Promise((_,rej)=>{ t=setTimeout(()=>rej(new Error('timeout:'+label)), ms); });
      return Promise.race([promise, timer]).finally(()=>clearTimeout(t));
    }
    async function fetchMethods(email){
      if(!auth) throw new Error('no_auth');
      const methods = await withTimeout(auth.fetchSignInMethodsForEmail(email), TIMEOUTS.methods, 'methods');
      return Array.isArray(methods) ? methods : [];
    }

    /* -------- Invite helpers (optional) -------- */
    async function loadInvite(token){
      if(!db) return null;
      try{
        const snap = await withTimeout(db.collection('invites').doc(token).get(), TIMEOUTS.invite, 'invite');
        if(!snap.exists) return null;
        return snap.data() || null;
      }catch(_){ return null; }
    }
    async function acceptInvite(token, email, uid){
      if(!db) return {ok:false};
      try{
        const ref = db.collection('invites').doc(token);
        return await withTimeout(
          db.runTransaction(async (tx)=>{
            const snap = await tx.get(ref);
            if(!snap.exists) return {ok:false, reason:'not_found'};
            const iv = snap.data() || {};
            if(iv.status && iv.status !== 'pending') return {ok:false, reason:'consumed'};
            if(typeof iv.seatsRemaining === 'number' && iv.seatsRemaining <= 0) return {ok:false, reason:'no_seats'};
            const host = (email.split('@')[1]||'').toLowerCase();
            if(iv.email && String(iv.email).toLowerCase() !== email.toLowerCase()) return {ok:false, reason:'email_mismatch'};
            if(iv.domain && String(iv.domain).toLowerCase() !== host) return {ok:false, reason:'domain_mismatch'};
            tx.update(ref, {
              status: 'accepted',
              acceptedBy: email, acceptedUid: uid || null,
              acceptedAt: firebase.firestore.FieldValue.serverTimestamp(),
              seatsRemaining: typeof iv.seatsRemaining==='number' ? Math.max(0, iv.seatsRemaining-1) : firebase.firestore.FieldValue.delete()
            });
            return {ok:true};
          }),
          TIMEOUTS.invite,'invite-tx'
        );
      }catch(_){ return {ok:false, reason:'tx_failed'}; }
    }

    /* -------- After-login routing: unify via /auth/bridge -------- */
    function goToBridge(from){
      const email = (document.getElementById('email')?.value || localStorage.getItem('gg_pending_email') || '').trim();
      const hostFromEmail = (email.match(/@([^@\s>]+)/)?.[1] || '').toLowerCase();
      const params = new URLSearchParams({
        from: from || 'login',
        email,
        site: hostFromEmail || (localStorage.getItem('preWebsite') || sessionStorage.getItem('preWebsite') || '')
      });
      const nx = sessionStorage.getItem('gg_next') || '';
      if (nx) params.set('next', nx);
      document.body.classList.add('leaving');
      setTimeout(()=>{ location.href = `/auth/bridge/?${params}`; }, 150);
    }

    /* -------- Auto-route on cached, verified session (free) -------- */
    function hookAuthStateAutoRoute(){
      if(!auth) return;
      auth.onAuthStateChanged(async (user)=>{
        if(!user) return;
        try{ await user.reload(); }catch(_){}
        if(user.emailVerified){ try{ localStorage.setItem('gg_pending_email', user.email || ''); }catch(_){}
          goToBridge('resume'); }
        else{
          // Show verify panel, allow resend/sign-out
          vEmail.textContent = user.email || '';
          verifyPanel.hidden = false;
          byId('s2-or').hidden = true; pwdWrap.hidden = true; backBtn.hidden = false;
        }
      });
    }

    /* -------- EMAIL NEXT -------- */
    emailNext.addEventListener('click', async ()=>{
      hideStatus();
      const email = (emailInput.value || '').trim();
      if(!looksValidEmail(email)){ pulse(emailBox); showStatus("Enter a valid email."); return; }
      if(!auth){ showStatus("Authentication isn't configured. Add Firebase keys."); return; }

      let methods = [];
      try{
        methods = await fetchMethods(email);
      }catch(e){
        if(String(e.message||'').startsWith('timeout')){ showStatus("Connection is slow. Try again."); return; }
        showStatus("We couldn't check that email. Try again."); return;
      }

      if(methods.length){
        if(methods.includes('password')){ setPasswordStage(); return; }
        if(methods.includes('google.com')){
          showStatusHTML(`Use <strong>Google</strong> sign-in for ${email.replace(/</g,'&lt;')}.`);
          googleBtn.focus(); return;
        }
        showStatus("Use your configured sign-in method."); return;
      }

      if(INVITE_CODE){ setPasswordStage(); return; }

      const u = new URL('/auth/signup/', location.origin);
      const nx = sessionStorage.getItem('gg_next'); if (nx) u.searchParams.set('next', nx);
      u.searchParams.set('email', email);
      showStatusHTML(`No account found. <a href="${u.pathname+u.search}">Create one?</a>`);
    });

    /* -------- BACK -------- */
    backBtn.addEventListener('click', setEmailStage);

    /* -------- PASSWORD SUBMIT -------- */
    pwdNext.addEventListener('click', async ()=>{
      bumpTryCount();
      hideStatus();
      const email = (emailInput.value || '').trim();
      const pwd = pwdInput.value;
      if(!looksValidEmail(email)){ setEmailStage(); pulse(emailBox); showStatus("Enter a valid email first."); return; }
      if(pwd.length < 6){ showStatus("Password is too short."); return; }
      if(!auth){ showStatus("Authentication isn't configured. Add Firebase keys."); return; }

      let methods = [];
      try{ methods = await fetchMethods(email); }catch(_){}

      const needHuman = humanNeeded(INVITE_CODE ? 'invite' : 'login');
      if (needHuman){
        const human = await getHumanToken(INVITE_CODE ? 'invite_login' : 'password_login');
        const hr = await verifyHumanServerSide({ provider: human.provider, token: human.token, action: INVITE_CODE ? 'invite_login' : 'password_login' });
        if(hr && hr.ok === false){ showStatus("Human verification failed."); resetHuman(); return; }
      }

      if(methods.includes('password')){
        try{
          const cred = await withTimeout(auth.signInWithEmailAndPassword(email, pwd), TIMEOUTS.sign, 'signin');
          try{ await cred.user.reload(); }catch(_){}
          try{ localStorage.setItem('gg_pending_email', email); }catch(_){}
          if(cred.user.emailVerified){ goToBridge('password'); }
          else{
            vEmail.textContent = cred.user.email || email;
            verifyPanel.hidden = false; byId('s2-or').hidden = true; // stay on page until verified
          }
        }catch(e){
          if(e?.code === 'auth/wrong-password'){ showStatus("Wrong password. Try again or reset."); return; }
          if(e?.code === 'auth/user-disabled'){ showStatus("This account is disabled."); return; }
          if(e?.code === 'auth/network-request-failed'){ showStatus("Network problem. Try again."); return; }
          showStatus("We couldn't sign you in. Try again.");
        } finally { resetHuman(); }
        return;
      }

      // Invite-first login (password path)
      if(INVITE_CODE){
        if(!db){ showStatus("Invite acceptance isn't available right now."); resetHuman(); return; }
        try{
          const iv = await loadInvite(INVITE_CODE);
          if(!iv){ showStatus("Invite is invalid or expired."); resetHuman(); return; }
          const host = (email.split('@')[1]||'').toLowerCase();
          if(iv.email && String(iv.email).toLowerCase() !== email.toLowerCase()){ showStatus("This invite is for a different email."); resetHuman(); return; }
          if(iv.domain && String(iv.domain).toLowerCase() !== host){ showStatus("This invite is for a different company domain."); resetHuman(); return; }

          let cred;
          try{
            cred = await withTimeout(auth.createUserWithEmailAndPassword(email, pwd), TIMEOUTS.create, 'create');
          }catch(e){
            if(e?.code === 'auth/email-already-in-use'){ showStatus("That email already has an account. Try signing in."); setEmailStage(); resetHuman(); return; }
            if(e?.code === 'auth/weak-password'){ showStatus("Password is too weak."); resetHuman(); return; }
            if(String(e?.message||'').startsWith('timeout')){ showStatus("It's taking too long. Check your connection and retry."); resetHuman(); return; }
            showStatus("We couldn't create your account. Try again."); resetHuman(); return;
          }

          try{ await acceptInvite(INVITE_CODE, email, cred?.user?.uid || null); }catch(_){}
          try{ localStorage.setItem('gg_pending_email', email); }catch(_){}
          // New accounts must verify email → show panel
          vEmail.textContent = cred.user.email || email;
          verifyPanel.hidden = false; byId('s2-or').hidden = true;
          resetHuman();
          return;

        }catch(_){
          showStatus("We couldn't accept the invite right now. Try again."); resetHuman(); return;
        }
      }

      const u = new URL('/auth/signup/', location.origin);
      const nx = sessionStorage.getItem('gg_next'); if (nx) u.searchParams.set('next', nx);
      u.searchParams.set('email', email);
      showStatusHTML(`No account found. <a href="${u.pathname+u.search}">Create one?</a>`);
      resetHuman();
    });

    /* -------- Google sign-in -------- */
    googleBtn?.addEventListener('click', async (e)=>{
      e.preventDefault();
      bumpTryCount();
      hideStatus();
      if(!auth){ showStatus("Google sign-in isn't configured. Add Firebase keys."); return; }

      try{
        const needHuman = humanNeeded(INVITE_CODE ? 'invite' : 'login');
        if(needHuman){
          const tok = await getHumanToken('google_login');
          const vr = await verifyHumanServerSide({ provider: tok.provider, token: tok.token, action:'google_login' });
          if(vr && vr.ok === false){ showStatus('Human verification failed.'); return; }
        }

        const provider = new firebase.auth.GoogleAuthProvider();
        provider.setCustomParameters({ prompt: 'select_account' });
        const cred = await auth.signInWithPopup(provider);
        const user = cred.user;
        const isNew = cred?.additionalUserInfo?.isNewUser === true;
        const email = user?.email || "";
        const host = (email.split('@')[1]||'').toLowerCase();

        if(isNew){
          if(!INVITE_CODE){
            try{ await auth.currentUser?.delete(); }catch(_){}
            try{ await auth.signOut(); }catch(_){}
            const u = new URL('/auth/signup/', location.origin);
            const nx = sessionStorage.getItem('gg_next'); if (nx) u.searchParams.set('next', nx);
            if(email) u.searchParams.set('email', email);
            showStatusHTML(`No account found for <strong>${email.replace(/</g,'&lt;')}</strong>. <a href="${u.pathname+u.search}">Create one?</a>`);
            return;
          }
          const iv = await loadInvite(INVITE_CODE);
          if(!iv){
            try{ await auth.currentUser?.delete(); }catch(_){}
            try{ await auth.signOut(); }catch(_){}
            showStatus("Invite is invalid or expired."); return;
          }
          if(iv.email && String(iv.email).toLowerCase() !== email.toLowerCase()){
            try{ await auth.currentUser?.delete(); }catch(_){}
            try{ await auth.signOut(); }catch(_){}
            showStatus("This invite is for a different email."); return;
          }
          if(iv.domain && String(iv.domain).toLowerCase() !== host){
            try{ await auth.currentUser?.delete(); }catch(_){}
            try{ await auth.signOut(); }catch(_){}
            showStatus("This invite is for a different company domain."); return;
          }
          try{ await acceptInvite(INVITE_CODE, email, user?.uid || null); }catch(_){}
          try{ localStorage.setItem('gg_pending_email', email); }catch(_){}
          // Google users are typically verified; still check:
          if(user.emailVerified){ goToBridge('google'); }
          else{
            vEmail.textContent = user.email || email;
            verifyPanel.hidden = false; byId('s2-or').hidden = true;
          }
          return;
        }

        try{ localStorage.setItem('gg_pending_email', email); }catch(_){}
        if(user.emailVerified){ goToBridge('google'); }
        else{
          vEmail.textContent = user.email || email;
          verifyPanel.hidden = false; byId('s2-or').hidden = true;
        }

      }catch(err){
        if(err?.code === 'auth/popup-closed-by-user') return;
        if(err?.code === 'auth/account-exists-with-different-credential'){ showStatus("Use your original sign-in method for this email."); return; }
        if(err?.code === 'auth/network-request-failed'){ showStatus("Network problem. Try again."); return; }
        if(err?.code === 'auth/operation-not-allowed'){ showStatus("Google sign-in is disabled for this project."); return; }
        showStatus("We couldn't complete Google sign-in. Try again.");
      } finally { resetHuman(); }
    });

    /* -------- Forgot password -------- */
    forgotLink.addEventListener('click', async (e)=>{
      e.preventDefault();
      hideStatus();
      const email = (emailInput.value || '').trim();
      if(!looksValidEmail(email)){ pulse(emailBox); showStatus("Enter your email above, then tap reset."); return; }
      if(!auth){ showStatus("Reset isn't available right now."); return; }
      try{
        await withTimeout(auth.sendPasswordResetEmail(email), TIMEOUTS.reset, 'reset');
        showStatus("Password reset link sent.", 'success');
      }catch(err){
        if(err?.code === 'auth/user-not-found'){ showStatus("No account found for that email."); return; }
        if(err?.code === 'auth/network-request-failed'){ showStatus("Network problem. Try again."); return; }
        showStatus("We couldn't send the reset email. Try again.");
      }
    });

    /* -------- Verify email (resend / change) -------- */
    async function sendVerifyLink(){
      if(!auth?.currentUser) throw new Error('no_user');
      const url = new URL('/auth/bridge/', location.origin);
      const nx = sessionStorage.getItem('gg_next') || '';
      if (nx) url.searchParams.set('next', nx);
      await withTimeout(auth.currentUser.sendEmailVerification({ url: url.href, handleCodeInApp: false }), TIMEOUTS.sendVerify, 'sendVerify');
      try{ localStorage.setItem('gg_pending_email', auth.currentUser.email || ''); }catch(_){}
      return true;
    }
    resendLink.addEventListener('click', async (e)=>{
      e.preventDefault(); hideStatus();
      try{ await sendVerifyLink(); showStatus("Verification email resent.", 'success'); }catch(_){ showStatus("We couldn't resend right now. Try again later."); }
    });
    changeEmail.addEventListener('click', async (e)=>{
      e.preventDefault();
      try{ await auth?.signOut(); }catch(_){}
      setEmailStage();
      emailInput.focus();
    });
  </script>
</body>
</html>