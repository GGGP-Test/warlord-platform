<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="robots" content="noindex, nofollow"/>
  <title>Warlord — Preparing workspace</title>

  <!-- API base (your Cloud Run URL) -->
  <meta name="api-base" content="">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@600;700;800&display=swap" rel="stylesheet"/>

  <style>
    :root {
      /* === WARLORD WHITE THEME === */
      --color-bg: #FAFAFA;
      --color-surface: #FFFFFF;
      --color-text: #0A0A0A;
      --color-text-muted: #6B7280;
      --color-text-light: #9CA3AF;
      --color-primary: #3B82F6;
      --color-accent: #10B981;
      --glass-bg: rgba(255, 255, 255, 0.9);
      --glass-border: rgba(0, 0, 0, 0.08);
      --glass-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
      --transition-base: 280ms cubic-bezier(0.4, 0, 0.2, 1);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', sans-serif;
      color: var(--color-text);
      background: linear-gradient(180deg, #FAFAFA 0%, #F5F5F5 100%);
      overflow: hidden;
    }

    .wrap {
      min-height: 100svh;
      display: grid;
      place-items: center;
      padding: 12svh 16px 10svh;
    }

    .head {
      width: min(560px, 92vw);
      margin: 0 auto 18px;
      padding: 12px 16px;
      border-radius: 12px;
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      border: 1px solid var(--glass-border);
      box-shadow: var(--glass-shadow);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .head .who {
      font-size: 14px;
      color: var(--color-text-muted);
    }

    .head strong {
      color: var(--color-text);
      font-weight: 700;
    }

    .ok {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--color-accent);
      box-shadow: 0 0 0 6px rgba(16, 185, 129, 0.15);
    }

    .stack {
      width: min(560px, 92vw);
      display: grid;
      gap: 16px;
      filter: drop-shadow(0 8px 24px rgba(0, 0, 0, 0.08));
    }

    .card {
      position: relative;
      display: grid;
      grid-template-columns: 38px 1fr;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      border-radius: 14px;
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      border: 1px solid var(--glass-border);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      transition: all var(--transition-base);
      overflow: hidden;
    }

    .card .title {
      font-weight: 700;
      font-size: 15px;
      letter-spacing: -0.01em;
    }

    .card .meta {
      color: var(--color-text-muted);
      font-size: 13px;
      margin-top: 2px;
    }

    .ic {
      width: 24px;
      height: 24px;
      display: grid;
      place-items: center;
      color: var(--color-text);
      opacity: 0.9;
    }

    .ic svg {
      width: 20px;
      height: 20px;
      display: block;
    }

    .bar {
      height: 6px;
      border-radius: 999px;
      background: rgba(59, 130, 246, 0.15);
      overflow: hidden;
      margin-top: 8px;
    }

    .fill {
      width: 30%;
      height: 100%;
      background: linear-gradient(90deg, var(--color-primary), #2563EB);
      animation: slide 1.4s linear infinite;
    }

    @keyframes slide {
      from { transform: translateX(-120%); }
      to { transform: translateX(220%); }
    }

    .slot-top {
      opacity: 0.5;
      transform: scale(0.96);
      filter: blur(0.2px);
    }

    .slot-main {
      opacity: 1;
      transform: scale(1);
      filter: blur(0);
    }

    .slot-bottom {
      opacity: 0.5;
      transform: scale(0.96);
      filter: blur(0.2px);
    }

    .is-pending .bar { display: none; }
    .is-done .bar { display: none; }

    .actions {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 12px;
    }

    .link {
      appearance: none;
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      color: var(--color-text);
      border: 1px solid var(--glass-border);
      border-radius: 10px;
      padding: 10px 16px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all var(--transition-base);
    }

    .link:hover {
      border-color: rgba(59, 130, 246, 0.3);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .sr {
      position: absolute;
      left: -9999px;
      width: 1px;
      height: 1px;
      overflow: hidden;
    }

    @media (prefers-reduced-motion: reduce) {
      * { animation-duration: 1ms !important; transition: none !important; }
    }
  </style>

  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
</head>
<body>

<div class="wrap">
  <div class="head">
    <div class="who">
      Preparing workspace for <strong id="h-email">—</strong>
      <span id="h-site" style="color:var(--color-text-muted)"></span>
    </div>
    <div class="ok" aria-hidden="true"></div>
  </div>

  <div class="stack" role="status" aria-live="polite">
    <div class="card slot-top is-done" id="card-top"></div>
    <div class="card slot-main is-active" id="card-main"></div>
    <div class="card slot-bottom is-pending" id="card-bottom"></div>
  </div>

  <div class="actions" id="actDefault">
    <button class="link" id="backBtn" type="button">Back</button>
  </div>
  <div class="actions" id="actConfirm" style="display:none">
    <button class="link" id="yesBtn" type="button">Yes, that's us</button>
    <button class="link" id="noBtn" type="button">No, change email</button>
  </div>

  <div class="sr" id="sr" aria-live="polite"></div>
</div>

<script>
  // Firebase Config
  const FIREBASE_CONFIG = {
    apiKey: "AIzaSyDk7vVnSiMfYJPJ38gbw21fzqsBTu1PbC8",
    authDomain: "warlord-1cbe3.firebaseapp.com",
    projectId: "warlord-1cbe3",
    storageBucket: "warlord-1cbe3.appspot.com",
    messagingSenderId: "123456789",
    appId: "1:123456789:web:abcdef"
  };

  firebase.initializeApp(FIREBASE_CONFIG);
  const auth = firebase.auth();

  const ENDPOINTS = {
    login: '/auth/login/',
    signup: '/auth/signup/',
    verified: '/auth/verified/'
  };

  const qs = new URLSearchParams(location.search);
  const emailQ = (qs.get('email') || '').trim();
  const roleQ = (qs.get('role') || '').trim();
  const siteQ = (qs.get('site') || '').replace(/^(https?:)?\/\//i, '').replace(/^www\./i, '').trim();
  const from = (qs.get('from') || '').trim();
  const nextQ = (qs.get('next') || '').trim();

  const LS = { role: 'gg_role', email: 'gg_email', site: 'gg_site', origin: 'gg_origin', apiBase: 'apiBase' };
  const role = roleQ || localStorage.getItem(LS.role) || '';
  const email = emailQ || localStorage.getItem(LS.email) || '';
  const site = siteQ || localStorage.getItem(LS.site) || '';

  if (role) try { localStorage.setItem(LS.role, role); } catch (_) {}
  if (email) try { localStorage.setItem(LS.email, email); } catch (_) {}
  if (site) try { localStorage.setItem(LS.site, site); } catch (_) {}

  document.getElementById('h-email').textContent = email || 'new user';
  document.getElementById('h-site').textContent = site ? `• ${site}` : '';

  function sanitizeNext(raw) {
    if (!raw) return '';
    try { raw = decodeURIComponent(raw); } catch (_) {}
    if (/^https?:/i.test(raw)) {
      try {
        const u = new URL(raw, location.origin);
        if (u.origin !== location.origin) return '';
        raw = u.pathname + u.search + u.hash;
      } catch (_) { return ''; }
    }
    if (!raw.startsWith('/')) return '';
    return raw.replace(/\/{2,}/g, '/');
  }
  const nextSafe = sanitizeNext(nextQ);

  const PERSONAL = new Set([
    "gmail.com", "googlemail.com", "yahoo.com", "ymail.com", "outlook.com",
    "hotmail.com", "live.com", "msn.com", "icloud.com", "me.com", "mac.com",
    "aol.com", "proton.me", "protonmail.com", "pm.me", "mail.com",
    "yandex.com", "yandex.ru", "gmx.com", "zoho.com", "fastmail.com",
    "hey.com", "inbox.com"
  ]);

  const emailHost = (() => {
    const m = String(email).match(/@([^@\s>]+)$/);
    return m ? m[1].toLowerCase() : '';
  })();

  function baseDomain(h) {
    if (!h) return '';
    const parts = h.toLowerCase().split('.').filter(Boolean);
    if (parts.length <= 2) return parts.join('.');
    const tlds2 = new Set(['co.uk', 'com.au', 'com.br', 'co.jp', 'co.in', 'com.mx', 'com.tr', 'com.cn', 'co.za', 'com.sg']);
    const last2 = parts.slice(-2).join('.');
    const last3 = parts.slice(-3).join('.');
    return tlds2.has(last2) ? last3 : last2;
  }

  function isBusinessEmailHost(h) {
    return !!h && !PERSONAL.has(h);
  }

  function bounce(backTo, code, msg) {
    const url = new URL(backTo || ENDPOINTS.signup, location.origin);
    if (code) url.searchParams.set('err', code);
    if (msg) url.searchParams.set('msg', msg);
    if (email) url.searchParams.set('email', email);
    if (site) url.searchParams.set('site', site);
    if (role) url.searchParams.set('role', role);
    if (nextSafe) url.searchParams.set('next', nextSafe);
    url.searchParams.set('auto', 'step2');
    location.replace(url.pathname + url.search + '#s2');
  }

  function pickOrigin() {
    const originHint = (sessionStorage.getItem(LS.origin) || '').trim();
    if (originHint === 'login' || originHint === 'signup') return originHint;
    return (role || site) ? 'signup' : 'login';
  }

  const sr = (t) => {
    const el = document.getElementById('sr');
    if (el) el.textContent = t;
  };

  function renderCard(el, title, meta, state) {
    el.className = el.className.replace(/\bis-(active|pending|done)\b/g, '').trim();
    el.classList.add('card');
    if (el.id === 'card-top') el.classList.add('slot-top');
    if (el.id === 'card-main') el.classList.add('slot-main');
    if (el.id === 'card-bottom') el.classList.add('slot-bottom');
    el.classList.add('is-' + (state || 'pending'));

    el.innerHTML = `
      <div class="ic" aria-hidden="true">
        ${state === 'done'
          ? `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
               <circle cx="12" cy="12" r="10"></circle><path d="M8 12l3 3 5-6"></path>
             </svg>`
          : `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
               <circle cx="12" cy="12" r="10" opacity=".9"></circle><path d="M12 6v6l4 2" opacity=".9"></path>
             </svg>`
        }
      </div>
      <div>
        <div class="title">${title}</div>
        <div class="meta">${meta || ''}</div>
        ${state === 'active' ? `<div class="bar"><div class="fill"></div></div>` : ``}
      </div>
    `;
  }

  const stepsSource = [
    ['Verifying details', email || 'Signing in'],
    ['Matching your domain', site || 'Detecting business website'],
    ['Scanning website', 'Public pages & metadata'],
    ['Enriching company data', 'Signals & contacts'],
    ['Configuring defaults', 'Preferences & roles'],
    ['Creating your workspace', 'Final touches']
  ];

  const topEl = document.getElementById('card-top');
  const mainEl = document.getElementById('card-main');
  const bottomEl = document.getElementById('card-bottom');

  let queue = stepsSource.map(([t, m]) => ({ title: t, meta: m }));
  if (queue.length < 3) queue = queue.concat(queue).slice(0, 3);

  renderCard(topEl, queue[0].title, queue[0].meta, 'done');
  renderCard(mainEl, queue[1].title, queue[1].meta, 'active');
  renderCard(bottomEl, queue[2].title, queue[2].meta, 'pending');

  function rotateOnce(nextTask) {
    renderCard(topEl, mainEl.querySelector('.title').textContent, mainEl.querySelector('.meta').textContent, 'done');
    renderCard(mainEl, bottomEl.querySelector('.title').textContent, bottomEl.querySelector('.meta').textContent, 'active');
    renderCard(bottomEl, nextTask.title, nextTask.meta, 'pending');
    sr(mainEl.querySelector('.title').textContent + '…');
  }

  async function getSession() {
    return new Promise((resolve) => {
      const unsubscribe = auth.onAuthStateChanged(user => {
        unsubscribe();
        if (user && user.emailVerified) {
          resolve({ ok: true, authenticated: true, user });
        } else {
          resolve({ ok: false, authenticated: false });
        }
      });
    });
  }

  function decideDestination(session) {
    if (nextSafe) return nextSafe;
    return '/auth/verified/';
  }

  function getApiBase() {
    const meta = document.querySelector('meta[name="api-base"]')?.content || "";
    const v = localStorage.getItem(LS.apiBase) || meta || "";
    return (v || "").trim().replace(/\/+$/, "");
  }

  function setApiBase(raw) {
    const v = (raw || "").trim().replace(/\/+$/, "");
    if (v) try { localStorage.setItem(LS.apiBase, v); } catch (_) {}
  }

  function ensureApi() {
    let base = getApiBase();
    if (!base) {
      const v = prompt("API base (your Cloud Run URL with /api). Example:\nhttps://warlord-api-123-uc.a.run.app/api", "") || "";
      if (v) { setApiBase(v); base = getApiBase(); }
    }
    return base;
  }

  function join(b, t) {
    return b.replace(/\/+$/, "") + "/" + String(t).replace(/^\/+/, "");
  }

  async function fetchClassify(host) {
    const base = ensureApi();
    if (!base) return null;
    const u1 = new URL(join(base, "/classify"));
    u1.searchParams.set("host", host);
    u1.searchParams.set("maxPages", "8");

    try {
      const r = await fetch(u1.toString(), { credentials: "omit" });
      const t = await r.text();
      try { return JSON.parse(t); } catch { return { ok: false, error: "bad_json", raw: t }; }
    } catch {
      return { ok: false, error: "network" };
    }
  }

  function imgReachable(host, timeoutMs = 3500) {
    return new Promise((resolve) => {
      if (!host) return resolve(false);
      const img = new Image();
      let done = false;
      const url = 'https://' + host + '/favicon.ico?__ping=' + Date.now();
      const timer = setTimeout(() => { if (!done) { done = true; resolve(false); } }, timeoutMs);
      img.onload = () => { if (!done) { done = true; clearTimeout(timer); resolve(true); } };
      img.onerror = () => { if (!done) { done = true; clearTimeout(timer); resolve(true); } };
      img.referrerPolicy = 'no-referrer';
      img.src = url;
    });
  }

  async function runValidations() {
    const hostFromSite = (site || '').toLowerCase();
    const hostFromEmail = emailHost;

    if (email && !isBusinessEmailHost(hostFromEmail)) {
      const backTo = pickOrigin() === 'login' ? ENDPOINTS.login : ENDPOINTS.signup;
      bounce(backTo, 'personal_email', 'Use a work email (Gmail/Outlook/Yahoo are not allowed).');
      return false;
    }

    if (hostFromSite && hostFromEmail && baseDomain(hostFromSite) !== baseDomain(hostFromEmail)) {
      const backTo = pickOrigin() === 'login' ? ENDPOINTS.login : ENDPOINTS.signup;
      bounce(backTo, 'domain_mismatch', `Your email domain (${baseDomain(hostFromEmail)}) doesn't match the website (${baseDomain(hostFromSite)}).`);
      return false;
    }

    const guessSite = hostFromSite || hostFromEmail || '';
    if (!guessSite) {
      const backTo = pickOrigin() === 'login' ? ENDPOINTS.login : ENDPOINTS.signup;
      bounce(backTo, 'no_site', 'Add your company website (work email or site).');
      return false;
    }

    const reachable = await imgReachable(guessSite);
    if (!reachable) {
      const backTo = pickOrigin() === 'login' ? ENDPOINTS.login : ENDPOINTS.signup;
      bounce(backTo, 'site_unreachable', 'We couldn\'t reach that site. Check that it\'s public and spelled correctly.');
      return false;
    }
    return true;
  }

  const actDefault = document.getElementById('actDefault');
  const actConfirm = document.getElementById('actConfirm');
  const yesBtn = document.getElementById('yesBtn');
  const noBtn = document.getElementById('noBtn');

  function showConfirmCard(payload) {
    const host = (payload?.host || site || '').replace(/^www\./, '');
    const fav = payload?.favicon || ('https://' + host + '/favicon.ico');
    const summary = (payload?.summary || '').trim();
    const line = summary || `We found ${host}.`;

    mainEl.className = mainEl.className.replace(/\bis-(active|pending|done)\b/g, '').trim();
    mainEl.classList.add('card', 'slot-main', 'is-active');
    mainEl.innerHTML = `
      <div class="ic" aria-hidden="true">
        <img alt="" src="${fav}" style="width:20px;height:20px;border-radius:4px;object-fit:cover" onerror="this.style.display='none'"/>
      </div>
      <div>
        <div class="title">Is this your company?</div>
        <div class="meta">${line}</div>
      </div>
    `;

    actDefault.style.display = 'none';
    actConfirm.style.display = 'flex';
  }

  function rejectToSignup(code, msg) {
    const backTo = pickOrigin() === 'login' ? ENDPOINTS.login : ENDPOINTS.signup;
    bounce(backTo, code, msg);
  }

  async function runSessionAndRoute() {
    const sessionPromise = getSession();
    let session = null, sessionResolved = false;
    sessionPromise.then(s => { sessionResolved = true; session = s; });

    let spent = 0, p = 2;
    async function spinWindow(msMin, msMax) {
      const until = Math.floor(msMin + Math.random() * (msMax - msMin));
      while (spent < until - 600) {
        const dwell = Math.floor(1500 + Math.random() * 900);
        p = (p + 1) % queue.length;
        rotateOnce(queue[p]);
        await new Promise(r => setTimeout(r, dwell));
        spent += dwell;
        if (sessionResolved) break;
      }
    }

    await spinWindow(1200, 2200);
    if (!sessionResolved) {
      await spinWindow(10000, 15000);
    }
    if (!sessionResolved) {
      session = await sessionPromise;
    }

    rotateOnce({ title: 'Creating your workspace', meta: 'Final checks' });
    await new Promise(r => setTimeout(r, 420));

    if (!session || session.ok === false) {
      rejectToSignup('not_authenticated', 'We couldn\'t confirm your sign-in. Please try again.');
      return;
    }
    if (!session.authenticated) {
      const msg = (from === 'password' || from === 'google')
        ? 'Almost there—complete sign-in or verification to continue.'
        : 'We couldn\'t confirm your sign-in. Please try again.';
      rejectToSignup('not_authenticated', msg);
      return;
    }

    const dest = decideDestination(session);
    location.href = dest;
  }

  async function startFlow() {
    const ok = await runValidations();
    if (!ok) return;

    const host = (site || emailHost || '').toLowerCase();
    let payload = { host: host, favicon: '', summary: '' };

    try {
      const data = await fetchClassify(host);
      if (data && data.ok) {
        payload.host = (data.host || host).toLowerCase();
        payload.favicon = data.favicon || '';
        payload.summary = (typeof data.summary === 'string' ? data.summary : '') || '';

        if (host && payload.host && baseDomain(payload.host) !== baseDomain(host)) {
          rejectToSignup('site_redirect_mismatch', `That domain forwards to ${payload.host}. Use your own company website.`);
          return;
        }

        if (data.robotsDenied) {
          rejectToSignup('robots_blocked', 'Your robots.txt blocks crawling. Please allow public access.');
          return;
        }
        if (data.crawlError) {
          rejectToSignup('site_not_readable', 'We couldn\'t read your public pages. Check availability and try again.');
          return;
        }
      }
    } catch (_) { /* fallback */ }

    showConfirmCard(payload);

    yesBtn.onclick = async () => {
      actConfirm.style.display = 'none';
      actDefault.style.display = 'flex';
      await runSessionAndRoute();
    };

    noBtn.onclick = () => {
      rejectToSignup('not_you', 'Update your business email to point to the right website.');
    };
  }

  document.getElementById('backBtn').addEventListener('click', () => {
    if (history.length > 1) {
      history.back();
      return;
    }
    const backTo = pickOrigin() === 'login' ? ENDPOINTS.login : ENDPOINTS.signup;
    location.href = backTo + (nextSafe ? ('?next=' + encodeURIComponent(nextSafe)) : '');
  });

  startFlow();
</script>

</body>
</html>