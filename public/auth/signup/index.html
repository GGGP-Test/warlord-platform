<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="robots" content="noindex, nofollow"/>
  <title>Warlord — Sign Up</title>

  <!-- Plus Jakarta Sans for headings -->
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@600;700;800&display=swap" rel="stylesheet"/>
  
  <!-- Inter for body text -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <style>
    :root {
      /* === WARLORD WHITE THEME === */
      --content-w: min(960px, 92vw);
      --title-fs: clamp(28px, 5.6vw, 48px);
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
      
      /* Colors - Premium Light Theme */
      --color-bg: #FAFAFA;
      --color-surface: #FFFFFF;
      --color-text: #0A0A0A;
      --color-text-muted: #6B7280;
      --color-text-light: #9CA3AF;
      --color-primary: #3B82F6;
      --color-primary-hover: #2563EB;
      --color-primary-light: #DBEAFE;
      --color-border: #E5E7EB;
      --color-error: #EF4444;
      
      /* Glass Morphism */
      --glass-bg: rgba(255, 255, 255, 0.8);
      --glass-border: rgba(0, 0, 0, 0.08);
      --glass-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
      
      /* Animation */
      --transition-base: 280ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
    }

    * { box-sizing: border-box; }
    
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: var(--color-bg);
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      color: var(--color-text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      
      /* Subtle gradient background */
      background: linear-gradient(180deg, #FAFAFA 0%, #F5F5F5 100%);
    }

    .wrap {
      min-height: 100dvh;
      display: grid;
      place-items: center;
      padding: calc(20px + var(--safe-top)) 16px calc(20px + var(--safe-bottom));
    }

    .stage {
      width: var(--content-w);
      transition: opacity var(--transition-base), transform var(--transition-base);
    }

    /* Topbar */
    .topbar {
      position: fixed;
      top: calc(var(--safe-top) + 16px);
      left: 0;
      right: 0;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--color-text);
      text-decoration: none;
      padding: 8px 12px;
      border-radius: 12px;
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      border: 1px solid var(--glass-border);
      box-shadow: var(--glass-shadow);
      transition: all var(--transition-fast);
    }

    .brand:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
    }

    .brand-icon {
      width: 24px;
      height: 24px;
      background: linear-gradient(135deg, var(--color-primary) 0%, #2563EB 100%);
      border-radius: 6px;
      display: grid;
      place-items: center;
      color: white;
      font-weight: 800;
      font-size: 14px;
    }

    .brand-text {
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-weight: 800;
      font-size: 16px;
      letter-spacing: -0.01em;
    }

    /* Typography */
    h1 {
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-weight: 800;
      font-size: var(--title-fs);
      line-height: 1.1;
      margin: 0 0 16px 0;
      text-align: center;
      letter-spacing: -0.02em;
      color: var(--color-text);
    }

    .subtitle {
      color: var(--color-text-muted);
      font-size: 16px;
      margin: 0 0 32px 0;
      text-align: center;
      line-height: 1.5;
    }

    /* Steps */
    .step {
      display: none;
    }

    .step.active {
      display: block;
    }

    /* Choice Cards */
    .choices {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      margin-bottom: 24px;
    }

    @media (min-width: 720px) {
      .choices {
        grid-template-columns: 1fr 1fr;
      }
    }

    .choice {
      position: relative;
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      border: 2px solid var(--glass-border);
      border-radius: 16px;
      padding: 24px;
      cursor: pointer;
      transition: all var(--transition-base);
      display: flex;
      gap: 16px;
      align-items: flex-start;
    }

    .choice:hover {
      transform: translateY(-4px);
      border-color: rgba(59, 130, 246, 0.3);
      box-shadow: 0 12px 24px rgba(59, 130, 246, 0.12);
    }

    .choice.selected {
      border-color: var(--color-primary);
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15), 0 8px 20px rgba(59, 130, 246, 0.15);
    }

    .choice-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--color-primary-light) 0%, rgba(59, 130, 246, 0.1) 100%);
      display: grid;
      place-items: center;
      flex-shrink: 0;
    }

    .choice-icon svg {
      width: 24px;
      height: 24px;
      color: var(--color-primary);
    }

    .choice h3 {
      margin: 0 0 8px 0;
      font-size: 18px;
      font-weight: 700;
      color: var(--color-text);
    }

    .choice p {
      margin: 0;
      font-size: 14px;
      line-height: 1.5;
      color: var(--color-text-muted);
    }

    /* Buttons */
    .row-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .btn-icon {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(135deg, var(--color-primary) 0%, #2563EB 100%);
      color: white;
      display: grid;
      place-items: center;
      cursor: pointer;
      transition: all var(--transition-base);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
    }

    .btn-icon:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.35);
    }

    .btn-icon:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none !important;
    }

    .btn-icon svg {
      width: 20px;
      height: 20px;
    }

    /* OAuth Buttons */
    .chip-row {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 24px;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 12px 20px;
      border-radius: 12px;
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      border: 1px solid var(--glass-border);
      color: var(--color-text);
      font-weight: 600;
      font-size: 15px;
      text-decoration: none;
      transition: all var(--transition-base);
      box-shadow: var(--glass-shadow);
    }

    .chip:hover {
      transform: translateY(-2px);
      border-color: rgba(59, 130, 246, 0.3);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08);
    }

    .chip svg {
      width: 20px;
      height: 20px;
    }

    /* Divider */
    .hr {
      width: 100%;
      max-width: 560px;
      height: 1px;
      margin: 24px auto;
      background: linear-gradient(90deg, transparent, var(--color-border), transparent);
    }

    .muted {
      color: var(--color-text-muted);
      font-size: 14px;
      text-align: center;
      margin: 0 0 24px 0;
    }

    /* Form Fields */
    .field-wrap {
      width: min(420px, 100%);
      margin: 0 auto 16px;
      position: relative;
    }

    .pressed {
      position: relative;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 0 16px;
      height: 52px;
      background: var(--color-surface);
      border: 1.5px solid var(--color-border);
      border-radius: 12px;
      transition: all var(--transition-fast);
    }

    .pressed:focus-within {
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .left-icon {
      width: 20px;
      height: 20px;
      color: var(--color-text-muted);
      flex-shrink: 0;
    }

    input {
      flex: 1;
      border: none;
      outline: none;
      background: transparent;
      font-size: 15px;
      color: var(--color-text);
      font-family: 'Inter', sans-serif;
    }

    input::placeholder {
      color: var(--color-text-light);
    }

    .field-cta {
      position: absolute;
      right: 6px;
      top: 50%;
      transform: translateY(-50%) scale(0.9);
      opacity: 0;
      pointer-events: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(135deg, var(--color-primary) 0%, #2563EB 100%);
      color: white;
      display: grid;
      place-items: center;
      cursor: pointer;
      transition: all var(--transition-base);
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.25);
    }

    .pressed.show-cta .field-cta {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(-50%) scale(1);
    }

    .field-cta:hover {
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.35);
    }

    .field-cta svg {
      width: 18px;
      height: 18px;
    }

    /* Status Messages */
    .inline-error {
      width: min(420px, 100%);
      margin: 0 auto 16px;
      padding: 12px 16px;
      border-radius: 12px;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.2);
      color: #DC2626;
      font-size: 14px;
      line-height: 1.5;
    }

    .inline-error a {
      color: #DC2626;
      font-weight: 600;
      text-decoration: underline;
    }

    .inline-note {
      width: min(420px, 100%);
      margin: 0 auto 16px;
      padding: 12px 16px;
      border-radius: 12px;
      background: var(--color-primary-light);
      border: 1px solid rgba(59, 130, 246, 0.2);
      color: var(--color-primary-hover);
      font-size: 14px;
      line-height: 1.5;
    }

    .small-row {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-top: 16px;
      font-size: 14px;
      color: var(--color-text-muted);
    }

    .small-row a {
      color: var(--color-primary);
      text-decoration: none;
      font-weight: 500;
      cursor: pointer;
    }

    .small-row a:hover {
      text-decoration: underline;
    }

    /* Animations */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-in {
      animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) both;
    }

    body.leaving .stage {
      opacity: 0;
      transform: translateY(10px) scale(0.98);
    }

    [hidden] {
      display: none !important;
    }

    /* Responsive */
    @media (max-width: 720px) {
      .topbar {
        padding: 0 16px;
      }

      h1 {
        font-size: 32px;
      }

      .choice {
        padding: 20px;
      }
    }
  </style>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>

  <div class="topbar">
    <a class="brand" href="/" aria-label="Warlord Platform">
      <div class="brand-icon">W</div>
      <span class="brand-text">Warlord</span>
    </a>
  </div>

  <main class="wrap">
    <div class="stage">

      <!-- STEP 1: Role Selection -->
      <section id="step1" class="step active" aria-labelledby="s1-title">
        <h1 id="s1-title">What brings you to Warlord?</h1>
        <p class="subtitle">Pick one to tailor your setup.</p>

        <div class="choices" role="listbox" aria-label="Select your role">
          <div class="choice" data-role="supplier" tabindex="0" role="option" aria-selected="false">
            <div class="choice-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 7h18v10H3z"></path><path d="M16 7V3H8v4"></path>
              </svg>
            </div>
            <div>
              <h3>Supplier — I sell packaging</h3>
              <p>Capture buyers already signaling intent, prioritize by timing, and let smart outreach run on autopilot.</p>
            </div>
          </div>

          <div class="choice" data-role="buyer" tabindex="0" role="option" aria-selected="false">
            <div class="choice-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 12.39a2 2 0 0 0 2 1.61h8.72a2 2 0 0 0 2-1.58L23 6H6"></path>
              </svg>
            </div>
            <div>
              <h3>Buyer — I buy packaging</h3>
              <p>Describe your need once—get matched to vetted suppliers fast, with clear timelines and quotes.</p>
            </div>
          </div>
        </div>

        <div class="row-actions">
          <button type="button" id="s1-next" class="btn-icon" aria-label="Continue" disabled>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 18l6-6-6-6"></path>
            </svg>
          </button>
        </div>
      </section>

      <!-- STEP 2: Email & Auth -->
      <section id="step2" class="step" aria-labelledby="s2-title">
        <div id="s2-top-start">
          <h1 id="s2-title">Get started with Warlord</h1>
          <p class="subtitle">Continue with</p>

          <div class="chip-row">
            <a class="chip" id="googleBtn" href="#" aria-label="Continue with Google">
              <svg width="20" height="20" viewBox="0 0 533.5 544.3" role="img">
                <path fill="#4285F4" d="M533.5 278.4c0-18.4-1.7-36-4.9-53.1H272v100.5h146.9c-6.3 34-25 62.8-53.1 82v68h85.7c50.1-46.2 81.9-114.1 81.9-197.4z"/>
                <path fill="#34A853" d="M272 544.3c72.2 0 132.8-23.9 177.1-64.9l-85.7-68c-23.8 16-54.2 25.5-91.4 25.5-70 0-129.4-47.2-150.6-110.8H33.1v69.6c44.2 87.8 135.2 148.6 238.9 148.6z"/>
                <path fill="#FBBC04" d="M121.4 326.1c-11.2-33.5-11.2-69.6 0-103.1V153.4H33.1c-40.1 79.9-40.1 175.2 0 255.1l88.3-69.6z"/>
                <path fill="#EA4335" d="M272 107.7c39.2-.6 76.7 14 104.8 41.2l78.3-78.3C411.7 18.1 344.2-5.3 272 0 168.3 0 77.3 60.8 33.1 148.6l88.3 69.6C142.7 154.6 202 107.7 272 107.7z"/>
              </svg>
              <span>Google</span>
            </a>
          </div>
        </div>

        <div id="s2-top-pass" hidden>
          <h1>Create your password</h1>
          <p class="subtitle">Your password must be at least 6 characters long.</p>
        </div>

        <div class="hr" aria-hidden="true"></div>

        <!-- Verification notice -->
        <div id="verifyPanel" class="inline-note" hidden>
          We sent a verification link to <strong id="vEmail">-</strong>. 
          Open it to verify, then <a id="loginLinkInline" href="/auth/login/">log in</a>.
          <div class="small-row">
            <a id="resendLink">Resend</a><span>·</span><a id="changeEmail">Use different email</a>
          </div>
        </div>

        <!-- Error messages -->
        <div id="inlineStatus" class="inline-error" role="alert" hidden></div>

        <div id="s2-bottom">
          <div class="muted">OR</div>

          <!-- Email input -->
          <div class="field-wrap">
            <div class="pressed" id="emailBox">
              <span class="left-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="5" width="18" height="14" rx="3"/><path d="M3 7l9 6 9-6"/>
                </svg>
              </span>
              <input id="email" type="email" inputmode="email" autocomplete="email" placeholder="Work email"/>
              <button id="emailNext" class="field-cta" type="button" aria-label="Next">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 18l6-6-6-6"></path>
                </svg>
              </button>
            </div>
          </div>

          <!-- Password input (shown after email validation) -->
          <div class="field-wrap" id="pwdWrap" hidden>
            <div class="pressed" id="pwdBox">
              <span class="left-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="11" width="18" height="10" rx="3"/><path d="M7 11V8a5 5 0 0 1 10 0v3"/>
                </svg>
              </span>
              <input id="password" type="password" autocomplete="new-password" placeholder="Password (min 6 characters)"/>
              <button id="pwdNext" class="field-cta" type="button" aria-label="Create account">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 18l6-6-6-6"></path>
                </svg>
              </button>
            </div>
          </div>

          <div class="row-actions">
            <button type="button" id="s2-back" class="btn-icon" aria-label="Back">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M15 18l-6-6 6-6"></path>
              </svg>
            </button>
          </div>

          <div class="small-row">
            <span>Already have an account?</span>
            <a id="staticLoginLink" href="/auth/login/">Log in</a>
          </div>
        </div>
      </section>

    </div>
  </main>

  <script>
    // Firebase Config - Warlord Platform
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyDk7vVnSiMfYJPJ38gbw21fzqsBTu1PbC8",
      authDomain: "warlord-1cbe3.firebaseapp.com",
      projectId: "warlord-1cbe3",
      storageBucket: "warlord-1cbe3.appspot.com",
      messagingSenderId: "123456789",
      appId: "1:123456789:web:abcdef"
    };

    // Initialize Firebase
    firebase.initializeApp(FIREBASE_CONFIG);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // DOM Elements
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const s1Next = document.getElementById('s1-next');
    const s2Back = document.getElementById('s2-back');
    const emailInput = document.getElementById('email');
    const emailBox = document.getElementById('emailBox');
    const emailNext = document.getElementById('emailNext');
    const pwdWrap = document.getElementById('pwdWrap');
    const pwdBox = document.getElementById('pwdBox');
    const pwdInput = document.getElementById('password');
    const pwdNext = document.getElementById('pwdNext');
    const statusEl = document.getElementById('inlineStatus');
    const verifyPanel = document.getElementById('verifyPanel');
    const s2TopStart = document.getElementById('s2-top-start');
    const s2TopPass = document.getElementById('s2-top-pass');

    // Personal email domains to block
    const PERSONAL_DOMAINS = new Set([
      'gmail.com', 'googlemail.com', 'yahoo.com', 'outlook.com', 
      'hotmail.com', 'live.com', 'icloud.com', 'aol.com', 'protonmail.com'
    ]);

    let role = null;
    let busy = false;
    let validatedEmail = null; // Track which email has been validated

    // Helper functions
    function showError(msg) {
      statusEl.textContent = msg;
      statusEl.hidden = false;
    }

    function hideError() {
      statusEl.hidden = true;
      statusEl.textContent = '';
    }

    function isValidEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i.test(email.trim());
    }

    function isBusinessEmail(email) {
      const domain = email.split('@')[1]?.toLowerCase();
      return domain && !PERSONAL_DOMAINS.has(domain);
    }

    function updateEmailCTA() {
      const currentEmail = emailInput.value.trim();
      const valid = isValidEmail(currentEmail) && pwdWrap.hidden;
      emailBox.classList.toggle('show-cta', valid);
      
      // If email changed and password field is visible, hide password field
      if (!pwdWrap.hidden && currentEmail !== validatedEmail) {
        // Email was changed after password field shown - reset to email validation
        s2TopPass.hidden = true;
        s2TopStart.hidden = false;
        pwdWrap.hidden = true;
        pwdInput.value = '';
        verifyPanel.hidden = true;
        validatedEmail = null;
        hideError();
        // Show the email next button if email is valid
        emailBox.classList.toggle('show-cta', isValidEmail(currentEmail));
      }
    }

    function updatePwdCTA() {
      const valid = pwdInput.value.length >= 6;
      pwdBox.classList.toggle('show-cta', valid);
    }

    // Step 1: Role Selection
    document.querySelectorAll('.choice').forEach(el => {
      const r = el.getAttribute('data-role');
      const selectRole = () => {
        role = r;
        document.querySelectorAll('.choice').forEach(c => {
          c.classList.toggle('selected', c === el);
          c.setAttribute('aria-selected', c === el ? 'true' : 'false');
        });
        s1Next.disabled = false;
      };
      el.addEventListener('click', selectRole);
      el.addEventListener('keydown', e => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          selectRole();
        }
      });
    });

    s1Next.addEventListener('click', () => {
      if (!role) return;
      step1.classList.remove('active');
      step2.classList.add('active');
    });

    // Step 2: Back button
    s2Back.addEventListener('click', () => {
      if (pwdWrap.hidden) {
        step2.classList.remove('active');
        step1.classList.add('active');
      } else {
        // Go back from password to email
        s2TopPass.hidden = true;
        s2TopStart.hidden = false;
        pwdWrap.hidden = true;
        pwdInput.value = '';
        verifyPanel.hidden = true;
        validatedEmail = null;
        hideError();
      }
    });

    // Email input handlers
    emailInput.addEventListener('input', updateEmailCTA);
    emailInput.addEventListener('keydown', e => {
      if (e.key === 'Enter' && isValidEmail(emailInput.value)) {
        e.preventDefault();
        emailNext.click();
      }
    });

    // Email validation & proceed to password
    emailNext.addEventListener('click', async () => {
      if (busy) return;
      hideError();

      const email = emailInput.value.trim();
      if (!isValidEmail(email)) {
        showError('Please enter a valid email address.');
        return;
      }
      if (!isBusinessEmail(email)) {
        showError('Please use a work email (not Gmail, Yahoo, etc.).');
        return;
      }

      busy = true;
      showError('Checking email...');

      try {
        // Check if email already exists
        const methods = await auth.fetchSignInMethodsForEmail(email);
        if (methods && methods.length > 0) {
          hideError();
          showError('Account already exists. Please log in.');
          busy = false;
          return;
        }

        // Proceed to password step
        validatedEmail = email; // Store validated email
        hideError();
        s2TopStart.hidden = true;
        s2TopPass.hidden = false;
        pwdWrap.hidden = false;
        emailBox.classList.remove('show-cta');
        pwdInput.focus();
        busy = false;
      } catch (err) {
        showError('Network error. Please try again.');
        busy = false;
      }
    });

    // Password input handlers
    pwdInput.addEventListener('input', updatePwdCTA);
    pwdInput.addEventListener('keydown', e => {
      if (e.key === 'Enter' && pwdInput.value.length >= 6) {
        e.preventDefault();
        pwdNext.click();
      }
    });

    // Create account
    pwdNext.addEventListener('click', async () => {
      if (busy) return;
      hideError();

      const email = emailInput.value.trim();
      const password = pwdInput.value;

      // Re-validate email in case user changed it
      if (!isValidEmail(email)) {
        showError('Please enter a valid email address.');
        return;
      }
      if (!isBusinessEmail(email)) {
        showError('Please use a work email (not Gmail, Yahoo, etc.).');
        return;
      }

      if (password.length < 6) {
        showError('Password must be at least 6 characters.');
        return;
      }

      busy = true;
      showError('Creating your account...');

      try {
        // Create user
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;

        // Send verification email
        await user.sendEmailVerification({
          url: window.location.origin + '/auth/bridge/',
          handleCodeInApp: false
        });

        // Store role in Firestore
        await db.collection('users').doc(user.uid).set({
          email: email,
          role: role,
          domain: email.split('@')[1].toLowerCase(),
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          emailVerified: false,
          onboardingStatus: 'email_verification'
        });

        // Show verification notice
        hideError();
        verifyPanel.hidden = false;
        document.getElementById('vEmail').textContent = email;
        busy = false;

      } catch (err) {
        console.error('Signup error:', err);
        if (err.code === 'auth/email-already-in-use') {
          showError('Account already exists. Please log in.');
        } else if (err.code === 'auth/weak-password') {
          showError('Password is too weak.');
        } else if (err.code === 'auth/network-request-failed') {
          showError('Network error. Please check your connection.');
        } else {
          showError('Could not create account. Please try again.');
        }
        busy = false;
      }
    });

    // Google Sign-in
    document.getElementById('googleBtn').addEventListener('click', async (e) => {
      e.preventDefault();
      if (busy) return;

      busy = true;
      hideError();

      try {
        const provider = new firebase.auth.GoogleAuthProvider();
        provider.setCustomParameters({ prompt: 'select_account' });

        const result = await auth.signInWithPopup(provider);
        const user = result.user;
        const email = user.email;
        const domain = email.split('@')[1].toLowerCase();

        // Check if personal domain
        if (PERSONAL_DOMAINS.has(domain)) {
          await auth.signOut();
          showError('Please use a work Google account (not personal Gmail).');
          busy = false;
          return;
        }

        // Check if new user
        if (result.additionalUserInfo.isNewUser) {
          // Store in Firestore
          await db.collection('users').doc(user.uid).set({
            email: email,
            role: role || 'supplier',
            domain: domain,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            emailVerified: true,
            onboardingStatus: 'bridge_pending',
            authMethod: 'google'
          });

          // Redirect to bridge
          window.location.href = '/auth/bridge/';
        } else {
          // Existing user - redirect to dashboard
          window.location.href = '/dashboard/';
        }

      } catch (err) {
        console.error('Google sign-in error:', err);
        if (err.code !== 'auth/popup-closed-by-user') {
          showError('Could not sign in with Google. Please try again.');
        }
        busy = false;
      }
    });
  </script>

</body>
</html>