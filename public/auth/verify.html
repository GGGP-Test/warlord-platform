<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify Email - Warlord</title>
    
    <!-- Firebase Configuration -->
    <script>
        window.__FIREBASE_CONFIG__ = {
            apiKey: "AIzaSyDk7vVnSiMfYJPJ38gbw21fzqsBTu1PbC8",
            authDomain: "warlord-1cbe3.firebaseapp.com",
            projectId: "warlord-1cbe3",
            storageBucket: "warlord-1cbe3.firebasestorage.app",
            messagingSenderId: "212906032385",
            appId: "1:212906032385:web:441058c2ed0c88ace16f00"
        };
    </script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: linear-gradient(135deg, #fafbfc 0%, #f5f7fa 25%, #eef1f5 50%, #f5f7fa 75%, #fafbfc 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .container {
            max-width: 500px;
            width: 100%;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            padding: 48px;
            text-align: center;
        }
        .icon {
            width: 80px; height: 80px; margin: 0 auto 24px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 40px;
        }
        .icon.loading { background: #3B5998; animation: pulse 1.5s infinite; }
        .icon.success { background: #10b981; color: white; }
        .icon.error { background: #ef4444; color: white; }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.9; } }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .spinner {
            width: 40px; height: 40px; border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        h1 { font-family: 'Plus Jakarta Sans', sans-serif; font-size: 28px; font-weight: 700; margin-bottom: 12px; }
        p { font-size: 16px; color: #64748b; line-height: 1.6; margin-bottom: 24px; }
        .email { font-weight: 600; color: #3B5998; }
        .button {
            display: inline-block; padding: 14px 32px; background: #3B5998; color: white;
            text-decoration: none; border-radius: 8px; font-weight: 600; transition: all 0.2s;
        }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div id="loading-state">
            <div class="icon loading"><div class="spinner"></div></div>
            <h1>Verifying Your Email...</h1>
            <p>Please wait while we verify your address.</p>
        </div>
        <div id="success-state" class="hidden">
            <div class="icon success">✓</div>
            <h1>Email Verified!</h1>
            <p>Account created for <span class="email" id="verified-email"></span></p>
            <p>Redirecting to dashboard...</p>
        </div>
        <div id="error-state" class="hidden">
            <div class="icon error">✕</div>
            <h1>Verification Failed</h1>
            <p id="error-message">Something went wrong.</p>
            <a href="/auth/signup/TEST.html" class="button">Back to Sign Up</a>
        </div>
    </div>

    <script>
        firebase.initializeApp(window.__FIREBASE_CONFIG__);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const PERSONAL_DOMAINS = new Set([
            'gmail.com', 'yahoo.com', 'hotmail.com', 'outlook.com', 'aol.com', 'icloud.com',
            'mail.com', 'protonmail.com', 'yandex.com', 'zoho.com', 'gmx.com', 'googlemail.com',
            'ymail.com', 'live.com', 'msn.com', 'me.com', 'mac.com', 'pm.me', 'fastmail.com', 'hey.com'
        ]);

        function extractDomain(email) {
            const match = email.match(/@([^@\s]+)$/);
            return match ? match[1].toLowerCase() : null;
        }

        function isBusinessEmail(email) {
            const domain = extractDomain(email);
            return domain && !PERSONAL_DOMAINS.has(domain);
        }

        async function verify() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const email = urlParams.get('email');

            if (!code || !email) {
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('error-state').classList.remove('hidden');
                document.getElementById('error-message').textContent = 'Invalid link.';
                return;
            }

            try {
                const pendingDoc = await db.collection('pendingVerifications').doc(email).get();
                if (!pendingDoc.exists || pendingDoc.data().verificationCode !== code) {
                    throw new Error('Link expired or invalid.');
                }

                const data = pendingDoc.data();
                const domain = extractDomain(email);

                // Final domain check
                if (isBusinessEmail(email)) {
                    const claim = await db.collection('domainClaims').doc(domain).get();
                    if (claim.exists && claim.data().status === 'verified') {
                        // If it's the same user trying to re-verify, it might be okay, but usually they should just login.
                        // However, if they are in pendingVerifications, they haven't finished yet.
                    }
                }

                let user;
                if (data.password) {
                    // Signup flow: Create User
                    const cred = await auth.createUserWithEmailAndPassword(email, data.password);
                    user = cred.user;
                } else {
                    // Magic link / submitEmail flow without password
                    // Check if user already exists
                    const methods = await auth.fetchSignInMethodsForEmail(email);
                    if (methods && methods.length > 0) {
                        // User exists, just mark as verified in Firestore if needed and redirect to login
                        // Since we can't sign them in without password or magic link token here,
                        // we just confirm verification.
                        document.getElementById('loading-state').classList.add('hidden');
                        document.getElementById('success-state').classList.remove('hidden');
                        document.getElementById('verified-email').textContent = email;
                        document.getElementById('success-state').querySelector('p:last-of-type').textContent = 'Email confirmed. Redirecting to login...';

                        await pendingDoc.ref.delete();
                        setTimeout(() => window.location.href = '/auth/login', 2000);
                        return;
                    } else {
                        throw new Error('No password provided. Please use the signup page.');
                    }
                }

                // Create Profile
                await db.collection('users').doc(user.uid).set({
                    email, domain, createdAt: firebase.firestore.FieldValue.serverTimestamp(), emailVerified: true
                });

                // Claim Domain
                if (isBusinessEmail(email)) {
                    await db.collection('domainClaims').doc(domain).set({
                        domain, claimedBy: user.uid, status: 'verified', claimedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }

                await pendingDoc.ref.delete();

                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('success-state').classList.remove('hidden');
                document.getElementById('verified-email').textContent = email;
                
                setTimeout(() => window.location.href = '/auth/verified', 2000);

            } catch (e) {
                console.error(e);
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('error-state').classList.remove('hidden');
                document.getElementById('error-message').textContent = e.message;
            }
        }
        verify();
    </script>
</body>
</html>
